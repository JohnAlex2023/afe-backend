================================================================================
                   ANÃLISIS EJECUTIVO - EXTRACCIÃ“N DE FACTURAS
                        Problema: Â¿DÃ³nde estÃ¡n las facturas?
================================================================================

PREGUNTA: "Â¿Por quÃ© NO se estÃ¡n pasando todas las facturas extraidas a la BD?
           Â¿Se extraen todas las facturas correspondientes a los NITs?"

RESPUESTA: ğŸ”´ NO SE EXTRAEN AUTOMÃTICAMENTE - El sistema falta el componente clave

================================================================================
                              1. ESTADO ACTUAL
================================================================================

Sistema esperado:

  Correos con PDFs â†’ [EXTRACTOR] â†’ Parseo PDF â†’ Filtro por NIT â†’ BD Facturas

Sistema actual:

  Usuario manualmente copia datos del PDF â†’ [API REST] â†’ BD Facturas

  âŒ EL EXTRACTOR NO EXISTE
  âŒ NO HAY DESCARGA AUTOMÃTICA DE EMAILS
  âŒ NO HAY PARSEO AUTOMÃTICO DE PDFs
  âŒ EL FILTRADO POR NIT NO FUNCIONA (porque no hay extracciÃ³n)

================================================================================
                          2. ARCHIVOS CLAVE ANALIZADOS
================================================================================

ARQUITECTURA DE EXTRACCIÃ“N:
  app/services/extractor/base.py                      âœ… Interface definida
  app/services/extractor/invoice_extractor_dummy.py   âœ… Solo para pruebas
  app/services/extractor/invoice_extractor_graph.py   âŒ âŒ âŒ NO EXISTE

CONFIGURACIÃ“N DE NITs:
  app/models/email_config.py                  âœ… Tablas: cuentas_correo, nit_configuracion
  app/crud/email_config.py                    âœ… Funciones CRUD para NITs
  app/api/v1/routers/email_config.py          âœ… Endpoints REST para configurar

PROCESAMIENTO:
  app/services/invoice_service.py             âœ… Espera FacturaCreate (manual)
  app/services/workflow_automatico.py         âœ… Asigna a responsables
  app/core/lifespan.py                        âœ… Scheduler cada hora
                                              âŒ Pero NO llama al extractor

INTEGRACIÃ“N MICROSOFT:
  app/services/microsoft_oauth_service.py     âœ… OAuth funciona
                                              âŒ Nunca se usa en flujo de extracciÃ³n

================================================================================
                        3. DIAGRAMA DEL PROBLEMA
================================================================================

PASO 1: OBTENER NITs CONFIGURADOS
  â””â”€ âœ… Implementado: get_cuentas_activas_para_extraccion(db)

     UbicaciÃ³n: app/crud/email_config.py:54-66

     Devuelve:
       CuentaCorreo(
         email="facturacion@empresa.com",
         nits=[
           NitConfiguracion(nit="800.123.456-7", activo=True),
           NitConfiguracion(nit="600.789.123-4", activo=True)
         ]
       )

PASO 2: DESCARGAR EMAILS DE MICROSOFT GRAPH
  â””â”€ âŒ NO IMPLEMENTADO

     PseudocÃ³digo esperado:
       graph_client = GraphClient(token)
       emails = graph_client.get_mails(
         folder="Inbox",
         filter="hasAttachments:true",
         from_date=7_days_ago
       )

PASO 3: PARSEAR PDF â†’ EXTRAER NIT
  â””â”€ âŒ NO IMPLEMENTADO

     PseudocÃ³digo esperado:
       pdf_data = extract_from_pdf(email.attachment)
       nit_emisor = pdf_data['nit_emisor']  # "800.123.456-7"
       numero_factura = pdf_data['numero']
       monto = pdf_data['total']

PASO 4: FILTRADO POR NIT CONFIGURADO â­ AQUÃ ES EL PROBLEMA
  â””â”€ âŒ NO IMPLEMENTADO (porque no hay extracciÃ³n)

     PseudocÃ³digo esperado:
       nits_configurados = [nit.nit for nit in cuenta.nits if nit.activo]

       if nit_emisor not in nits_configurados:
           logger.info(f"Ignorando factura {nit_emisor} - no configurado")
           continue  # â† FILTRADO

       # Si estÃ¡ configurado, procesar
       yield FacturaCreate(numero_factura, nit_emisor, monto, ...)

PASO 5: CREAR WORKFLOWS Y ASIGNAR A RESPONSABLES
  â””â”€ âœ… IMPLEMENTADO: WorkflowAutomaticoService.procesar_factura_nueva()

     UbicaciÃ³n: app/services/workflow_automatico.py:157-249

     Flujo:
     1. Extraer NIT de la factura
     2. Buscar AsignacionNitResponsable para ese NIT
     3. Crear WorkflowAprobacionFactura para cada responsable
     4. Analizar similitud con mes anterior
     5. Aprobar automÃ¡ticamente o enviar a revisiÃ³n

================================================================================
                       4. CUELLO DE BOTELLA IDENTIFICADO
================================================================================

El sistema falla en el PASO 4 (Filtrado por NIT) porque:

A. El extractor real NUNCA se ejecuta
   â””â”€ No hay cÃ³digo que descargue PDFs de emails

B. No hay validaciÃ³n preactiva
   â””â”€ Si llegara una factura con NIT no configurado, se crearÃ­a workflow incompleto
   â””â”€ Estado: "EN_REVISIÃ“N" esperando asignaciÃ³n manual

C. El scheduler NO vincula el extractor
   â””â”€ UbicaciÃ³n: app/core/lifespan.py:19-116
   â””â”€ Ejecuta: run_automation_task()
   â””â”€ Pero NO llama a: invoice_extractor.extract()

D. ConfiguraciÃ³n de NITs es MANUAL
   â””â”€ UbicaciÃ³n: POST /api/v1/email-config/nits
   â””â”€ Usuario debe crear manualmente cada NIT en el sistema
   â””â”€ No hay sincronizaciÃ³n con facturas que llegan

================================================================================
                         5. TABLA COMPARATIVA
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Componente              â”‚ Status       â”‚ UbicaciÃ³n    â”‚ Problema            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Interface Extractor     â”‚ âœ… Existe    â”‚ base.py      â”‚ Solo contrato       â”‚
â”‚ Extractor Dummy         â”‚ âœ… Existe    â”‚ dummy.py     â”‚ Solo para pruebas    â”‚
â”‚ Extractor Real          â”‚ âŒ FALTA     â”‚ graph.py (?) â”‚ ğŸ”´ BLOQUEADOR       â”‚
â”‚ Descarga Graph          â”‚ âŒ FALTA     â”‚ ?            â”‚ ğŸ”´ CRÃTICO          â”‚
â”‚ Parseo de PDF           â”‚ âŒ FALTA     â”‚ ?            â”‚ ğŸ”´ CRÃTICO          â”‚
â”‚ Filtrado por NIT        â”‚ âŒ FALTA     â”‚ ?            â”‚ ğŸ”´ CRÃTICO          â”‚
â”‚ ConfiguraciÃ³n NITs      â”‚ âœ… Existe    â”‚ email_cfg.py â”‚ Manual, funciona    â”‚
â”‚ Workflow AutomÃ¡tico     â”‚ âœ… Existe    â”‚ workflow.py  â”‚ Esperando facturas  â”‚
â”‚ Scheduler               â”‚ âœ… Existe    â”‚ lifespan.py  â”‚ No vinculado        â”‚
â”‚ ValidaciÃ³n Preactiva    â”‚ âš ï¸  Parcial  â”‚ invoice_svc  â”‚ Mejora necesaria    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
                        6. SOLUCIONES NECESARIAS
================================================================================

PRIORIDAD 1 (CRÃTICA): Implementar Extractor Real
  â”œâ”€ Crear: app/services/extractor/invoice_extractor_graph.py
  â”œâ”€ Implementar: Descarga desde Microsoft Graph
  â”œâ”€ Implementar: Parseo de PDFs
  â”œâ”€ Implementar: Filtrado por NIT configurado
  â”œâ”€ Retornar: Iterable[FacturaCreate]
  â””â”€ Tiempo estimado: 2-3 dÃ­as

PRIORIDAD 2 (ALTA): ValidaciÃ³n de NITs Pre-activa
  â”œâ”€ UbicaciÃ³n: app/services/invoice_service.py
  â”œâ”€ Cambio: Rechazar si NIT no estÃ¡ en AsignacionNitResponsable
  â”œâ”€ Evita: Workflows incompletos
  â””â”€ Tiempo estimado: 1 dÃ­a

PRIORIDAD 3 (ALTA): Vincular Extractor con Scheduler
  â”œâ”€ UbicaciÃ³n: app/core/lifespan.py
  â”œâ”€ Agregar: PASO 0 que llama a extractor.extract()
  â”œâ”€ Inicia: Proceso automÃ¡tico cada hora
  â””â”€ Tiempo estimado: 4 horas

================================================================================
                          7. CÃ“MO FUNCIONA AHORA
================================================================================

FLUJO ACTUAL (MANUAL):

  Usuario en Portal Web
    â†“ (manualmente copia datos del PDF)
  Ingresa: POST /api/v1/facturas/
    {
      "numero_factura": "FAC-001",
      "fecha_emision": "2025-10-30",
      "nit_emisor": "800.123.456-7",
      "subtotal": 1000.00,
      "iva": 190.00,
      "total_a_pagar": 1190.00,
      "cufe": "ABC123..."
    }
    â†“
  process_and_persist_invoice() en invoice_service.py:11-147
    â”œâ”€ Valida totales
    â”œâ”€ DeduplicaciÃ³n por CUFE
    â”œâ”€ DeduplicaciÃ³n por numero+proveedor
    â””â”€ Crea Factura en BD
    â†“
  WorkflowAutomaticoService.procesar_factura_nueva() en workflow_automatico.py:157
    â”œâ”€ Extrae NIT: "800.123.456-7"
    â”œâ”€ Busca: AsignacionNitResponsable.nit = "800.123.456-7"
    â”œâ”€ Si existe:
    â”‚  â”œâ”€ Crea WorkflowAprobacionFactura
    â”‚  â”œâ”€ Asigna a responsable
    â”‚  â”œâ”€ Analiza similitud con mes anterior
    â”‚  â””â”€ Aprueba automÃ¡tica o envÃ­a a revisiÃ³n
    â”œâ”€ Si NO existe:
    â”‚  â”œâ”€ Crea workflow incompleto (SIN responsable)
    â”‚  â””â”€ Factura queda en "EN_REVISIÃ“N" esperando asignaciÃ³n manual
    â†“
  NotificaciÃ³n enviada al responsable
    â†“
  Responsable aprueba/rechaza manualmente (si es necesario)

PROBLEMA: Solo se procesan las facturas que el usuario ingresa manualmente
SOLUCIÃ“N: Que el sistema EXTRAIGA automÃ¡ticamente de los emails

================================================================================
                          8. CÃ“MO DEBE FUNCIONAR
================================================================================

FLUJO ESPERADO (AUTOMÃTICO):

  Correo llega a inbox de facturacion@empresa.com
    â†“ (con PDF adjunto)
  â° Scheduler se ejecuta cada hora (lifespan.py:102)
    â†“
  run_automation_task()
    â†“
  PASO 0: EXTRACCIÃ“N (NUEVO)
    â”œâ”€ MicrosoftGraphInvoiceExtractor.extract()
    â”‚  â”œâ”€ get_cuentas_activas_para_extraccion() â†’ Cuenta + NITs
    â”‚  â”œâ”€ Para cada cuenta:
    â”‚  â”‚  â”œâ”€ download_from_graph(token) â†’ Lista emails
    â”‚  â”‚  â”œâ”€ Para cada email con PDF:
    â”‚  â”‚  â”‚  â”œâ”€ parse_pdf(pdf) â†’ nit, numero, monto, cufe
    â”‚  â”‚  â”‚  â”œâ”€ âœ… FILTRADO: Â¿NIT en cuenta.nits activos?
    â”‚  â”‚  â”‚  â”‚  â”œâ”€ SI: yield FacturaCreate
    â”‚  â”‚  â”‚  â”‚  â””â”€ NO: ignorar y log
    â”‚  â”‚  â””â”€ Marcar email como procesado
    â”‚  â””â”€ Yield todas las FacturaCreate
    â”‚
    â”œâ”€ FOR cada factura_create en extract():
    â”‚  â””â”€ process_and_persist_invoice(factura_create, created_by="INVOICE_EXTRACTOR")
    â”‚     â””â”€ Crea Factura en BD
    â†“
  PASO 1: WORKFLOW AUTOMÃTICO
    â”œâ”€ Para cada factura SIN workflow:
    â”‚  â”œâ”€ WorkflowAutomaticoService.procesar_factura_nueva()
    â”‚  â”œâ”€ Asigna a responsables configurados
    â”‚  â”œâ”€ Analiza similitud
    â”‚  â””â”€ Aprueba automÃ¡tica o envÃ­a a revisiÃ³n
    â†“
  PASO 2: PROCESAMIENTO DE DECISIONES
    â”œâ”€ Para facturas con workflow:
    â”‚  â”œâ”€ Aplica reglas de aprobaciÃ³n automÃ¡tica
    â”‚  â”œâ”€ Genera notificaciones
    â”‚  â””â”€ Sincroniza estados
    â†“
  Resultado: Tablero actualizado con todas las facturas

VENTAJAS:
  âœ… AutomÃ¡tico - sin intervenciÃ³n manual
  âœ… Filtrado - solo procesa NITs configurados
  âœ… Escalable - procesa cientos de facturas por hora
  âœ… Trazable - auditorÃ­a completa de cada paso
  âœ… Robusto - manejo de errores en cada PDF

================================================================================
                      9. CONFIGURACIÃ“N DE NITs (Manual)
================================================================================

Para que el sistema funcione, el usuario DEBE configurar:

1. Crear cuenta de correo:
   POST /api/v1/email-config/cuentas
   {
     "email": "facturacion@empresa.com",
     "nombre_descriptivo": "FacturaciÃ³n AngiografÃ­a",
     "max_correos_por_ejecucion": 10000,
     "ventana_inicial_dias": 30,
     "organizacion": "ANGIOGRAFIA"
   }

2. Agregar NITs a la cuenta:
   POST /api/v1/email-config/nits
   {
     "cuenta_correo_id": 1,
     "nit": "800.123.456-7",
     "nombre_proveedor": "Proveedor A",
     "activo": true
   }

3. Asignar responsables a cada NIT:
   POST /api/v1/asignacion-nit/asignar
   {
     "nit": "800.123.456-7",
     "responsable_id": 5,
     "area": "Compras"
   }

SI ESTO NO SE HACE: El sistema extraerÃ¡ facturas pero quedarÃ¡n SIN RESPONSABLE

================================================================================
                      10. VERIFICACIÃ“N RÃPIDA
================================================================================

Â¿Por quÃ© no se estÃ¡n pasando las facturas a BD?

1. âŒ Â¿Hay un script/endpoint que extraiga de emails?
   â†’ NO. No existe invoice_extractor_graph.py

2. âŒ Â¿Se descarga automÃ¡ticamente de Microsoft Graph?
   â†’ NO. OAuth existe pero nunca se usa en extracciÃ³n

3. âŒ Â¿Se parsean los PDFs automÃ¡ticamente?
   â†’ NO. No hay cÃ³digo que lea PDFs

4. âŒ Â¿Se filtra por NITs configurados?
   â†’ NO. No hay lÃ³gica de filtrado (porque no hay extracciÃ³n)

5. âœ… Â¿Funciona el workflow automÃ¡tico una vez que la factura estÃ¡ en BD?
   â†’ SÃ. Asigna responsables y aprueba automÃ¡ticamente

6. âœ… Â¿EstÃ¡n configurados los NITs en la BD?
   â†’ Depende. Si el usuario usÃ³ POST /api/v1/email-config/nits â†’ SÃ
   â†’ Si no, hay que agregar manualmente en nit_configuracion table

7. âœ… Â¿EstÃ¡n asignados responsables a los NITs?
   â†’ Depende. Si el usuario usÃ³ POST /api/v1/asignacion-nit/asignar â†’ SÃ
   â†’ Si no, hay que agregar en asignacion_nit_responsable table

================================================================================
                          11. RESUMEN CRÃTICO
================================================================================

PROBLEMA RAÃZ:
  No existe implementaciÃ³n del extractor automÃ¡tico de PDFs desde emails.
  El sistema es 80% automÃ¡tico pero el 20% inicial (extracciÃ³n) es manual.

IMPACTO:
  - Usuario debe copiar manualmente datos de cada PDF
  - No hay procesamiento en batch
  - No hay aprovechamiento de la configuraciÃ³n de NITs
  - Cuello de botella en entrada de datos

SOLUCIÃ“N:
  1. Implementar invoice_extractor_graph.py (2-3 dÃ­as)
  2. Agregar validaciÃ³n de NITs (1 dÃ­a)
  3. Vincular con scheduler (4 horas)

BENEFICIO:
  âœ… Facturas se procesan automÃ¡ticamente
  âœ… Se extraen TODAS las facturas de los NITs configurados
  âœ… Se aprueban automÃ¡ticamente segÃºn criterios
  âœ… Todo se sincroniza en tablero en tiempo real
  âœ… ReducciÃ³n de trabajo manual del 80%

ESTIMACIÃ“N TOTAL: 3-4 dÃ­as para implementaciÃ³n completa

================================================================================
                           FIN DEL ANÃLISIS
================================================================================

Documento: ANALISIS_PROBLEMA_EXTRACCION_FACTURAS.md
UbicaciÃ³n: c:\Users\jhont\PRIVADO_ODO\afe-backend\
Detalles tÃ©cnicos completos en archivo markdown

Preparado para: Development Team
Severidad: ğŸ”´ CRÃTICA
AcciÃ³n: ImplementaciÃ³n inmediata del extractor
